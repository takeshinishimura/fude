---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# fude

<!-- badges: start -->
[![R-CMD-check](https://github.com/takeshinishimura/fude/actions/workflows/check-standard.yaml/badge.svg)](https://github.com/takeshinishimura/fude/actions/workflows/check-standard.yaml)
[![CRAN status](https://www.r-pkg.org/badges/version/fude)](https://CRAN.R-project.org/package=fude)
<!-- badges: end -->

The fude package provides utilities to facilitate handling of Fude Polygon data downloadable from the Ministry of Agriculture, Forestry and Fisheries (MAFF) website. The word fude is a Japanese counter suffix used when referring to land parcels.

## Obtaining Data

Download the Fude Polygon data from the following release site of MAFF (only Japanese is available).

- <https://open.fude.maff.go.jp>

## Installation

You can install the released version of fude from CRAN with:
```r
install.packages("fude")
```

Or the development version from GitHub with:
```{r eval = FALSE}
# install.packages("devtools")
devtools::install_github("takeshinishimura/fude")
```

## Usage

You can let R read the downloaded ZIP file without unzipping it.
```{r eval = FALSE}
library(fude)
d <- read_fude("~/2022_38.zip")
```
```{r echo = FALSE}
library(fude)
d <- read_fude("~/2022_38.zip", quiet = TRUE)
```

Those who wish to use a mouse or trackpad for file selection, which is especially common among R beginners, can do the following.

```{r eval = FALSE}
d <- read_fude(file.choose())
```

You can rename the local government codes to the Japanese municipality names for easier handling.

```{r}
d2 <- rename_fude(d)
```

It can also be renamed to romaji instead of Japanese.
```{r}
d3 <- d |> rename_fude(suffix = TRUE, romaji = "title", quiet = TRUE)
names(d3)
```

You can download the agricultural community boundary data corresponding to the Fude Polygon data from the MAFF website <https://www.maff.go.jp/j/tokei/census/shuraku_data/2020/ma/> (only Japanese is available).
```{r eval = FALSE}
b <- get_boundary(d)
```
```{r echo = FALSE, warning = FALSE}
b <- get_boundary(d, path = "~", quiet = TRUE)
```

You can easily draw a map combining Fude Polygons and agricultural community boundaries.
```{r eval = FALSE}
library(ggplot2)

db <- combine_fude(d, b, city = "松山市", community = "御手洗|泊|船越|鷲ケ巣|由良|北浦|門田|馬磯")

ggplot() +
  geom_sf(data = db$community, fill = NA) +
  geom_sf(data = db$fude, aes(fill = land_type)) +
  guides(fill = guide_legend(title = "耕地の種類")) +
  theme_void()
```
```{r gogoshima, echo = FALSE, warning = FALSE, message = FALSE, dpi = 150}
library(ggplot2)

db <- combine_fude(d, b, city = "松山市", community = "由良|北浦|鷲ケ巣|門田|馬磯|泊|御手洗|船越")

ggplot() +
  geom_sf(data = db$community, fill = NA) +
  geom_sf(data = db$fude, aes(fill = land_type)) +
  guides(fill = guide_legend(title = "耕地の種類")) +
  theme_void() +
  theme(text = element_text(family = "HiraKakuProN-W3"))
```

**出典**：農林水産省が提供する「筆ポリゴンデータ（2022年度公開）」および「農業集落境界データ（2021年度公開）」を加工して作成。

If you want to be particular about the details of the map, for example, execute the following code.
```{r gogoshima_with_minimap, echo = TRUE, warning = FALSE, message = FALSE, dpi = 150}
library(magrittr)
library(dplyr)
library(ggrepel)
library(cowplot)

db <- combine_fude(d, b, city = "松山市", old_village = "興居島", community = "^(?!釣島).*")

minimap <- ggplot() +
  geom_sf(data = db$lg_all, aes(fill = fill)) +
  geom_sf_text(data = db$lg_all, aes(label = city_kanji), family = "HiraKakuProN-W3") +
  geom_sf(data = db$community_union, fill = "black", linewidth = 0) +
  theme_void() +
  theme(panel.background = element_rect(fill = "aliceblue")) +
  scale_fill_manual(values = c("white", "gray"))

mainmap <- ggplot() +
  geom_sf(data = db$community, fill = "whitesmoke") +
  geom_sf(data = db$fude, aes(fill = RCOM_NAME)) +
  geom_point(data = db$community, aes(x = X, y = Y), colour = "gray") +
  geom_text_repel(data = db$community,
                  aes(x = X, y = Y, label = RCOM_NAME),
                  nudge_x = c(-.01, .01, -.01, -.012, .005, -.01, .01, .01),
                  nudge_y = c(.005, .005, 0, .01, -.005, .01, 0, -.005),
                  min.segment.length = .01,
                  segment.color = "gray",
                  size = 3,
                  family = "HiraKakuProN-W3") +
  theme_void() +
  theme(legend.position = "none")

ggdraw(mainmap) +
  draw_plot(
    {minimap +
       geom_rect(aes(xmin = 132.47, xmax = 133.0,
                     ymin = 33.72, ymax = 34.05),
                 fill = NA,
                 colour = "black",
                 size = .5) +
       coord_sf(xlim = c(132.47, 133.0),
                ylim = c(33.72, 34.05),
                expand = FALSE) +
       theme(legend.position = "none")
    },
    x = .7, 
    y = 0,
    width = .3, 
    height = .3)
```

**出典**：農林水産省が提供する「筆ポリゴンデータ（2022年度公開）」および「農業集落境界データ（2021年度公開）」を加工して作成。

This package may be beneficial, especially for R beginners, when simply wanting to draw agricultural community boundaries.
```{r yawatahama, echo = TRUE, warning = FALSE, message = FALSE, dpi = 150}
db <- combine_fude(d, b, city = "八幡浜市", old_village = "真穴")

ggplot(data = db$community) +
  geom_sf(data = db$lg, fill = "gray") +
  geom_sf_text(data = db$lg, aes(label = city_kanji), family = "HiraKakuProN-W3") +
  geom_sf(fill = "ivory") +
# geom_sf(data = db$fude, aes(fill = land_type), colour = NA) +
  geom_sf_label(aes(label = RCOM_NAME), family = "HiraKakuProN-W3") +
  theme_void() +
  theme(legend.position = "none")
```

**出典**：農林水産省が提供する「筆ポリゴンデータ（2022年度公開）」および「農業集落境界データ（2021年度公開）」を加工して作成。

If you want to use `mapview()`, do the following.
```{r eval = FALSE}
library(mapview)

db1 <- combine_fude(d, b, city = "伊方町")
db2 <- combine_fude(d, b, city = "八幡浜市")
db3 <- combine_fude(d, b, city = "西予市", old_village = "三瓶|双岩|三島|二木生")
db <- bind_fude(db1, db2, db3)

mapview::mapview(db$fude, zcol = "RCOM_NAME", layer.name = "農業集落名")
```
